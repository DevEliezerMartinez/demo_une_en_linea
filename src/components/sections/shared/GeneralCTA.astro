---
// ContactSection.astro
import { ChevronDown } from "@lucide/astro";
import { Image } from "astro:assets";
import Instalaciones from "@/assets/Imagenes/Middles/Sillas.webp";
export interface Props {
  title?: string;
  subtitle?: string;
  className?: string;
  formSource?: string;
  backgroundImage?: boolean;
}

const {
  title = "Déjanos tus datos y nos contactaremos contigo",
  subtitle = "Estamos para ti",
  className = "",
  formSource = "form_home",
  backgroundImage = false,
} = Astro.props;

const niveles = [
  "Bachillerato",
  "Licenciatura",
  "Posgrado",

];
---

<section class={`relative py-12 sm:py-16 px-4 min-h-[400px] ${className}`}>
  {backgroundImage ? (
    <!-- Background Image -->
    <div class="absolute inset-0">
      <Image
        src={Instalaciones}
        alt="Instalaciones UNE"
        class="w-full h-full object-cover"
        loading="lazy"
      />
      <div class="absolute inset-0 bg-black/40"></div>
    </div>
  ) : (
    <!-- Gradient Background -->
    <div class="absolute inset-0 bg-gradient-to-br from-[#001A71] to-[#0A2DAA]">
    </div>
  )}

  <div class="relative z-10 max-w-6xl mx-auto">
    <div
      class="grid lg:grid-cols-2 gap-8 lg:gap-12 items-start lg:items-center"
    >
      <!-- Left Column: Title -->
      <div class="text-white text-center lg:text-left">
        <p class="text-base sm:text-lg font-medium mb-3 sm:mb-4">{subtitle}</p>
        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight">
          {title}
        </h2>
      </div>

      <!-- Right Column: Form -->
      <div class="w-full">
        <!-- Message Display Area -->
        <div id="message-container" class="mb-4 hidden">
          <div
            id="message-content"
            class="rounded-lg p-4 flex items-start gap-3 animate-fade-in"
          >
            <div id="message-icon" class="flex-shrink-0 mt-0.5"></div>
            <div class="flex-1 min-w-0">
              <p
                id="message-text"
                class="text-sm sm:text-base font-medium break-words"
              >
              </p>
              <button
                id="retry-btn"
                class="mt-2 text-sm underline hover:no-underline hidden"
              >
                Intentar de nuevo
              </button>
            </div>
          </div>
        </div>

        <form
          id="contact-form"
          data-form-source={formSource}
          class="space-y-4 sm:space-y-6 flex flex-col"
        >
          <input
            type="text"
            name="nombre"
            placeholder="Nombre(s)"
            required
            minlength="2"
            maxlength="100"
            autocomplete="given-name"
            class="w-full bg-transparent border-b-2 border-white/60 text-white placeholder-white/80 py-2 sm:py-3 focus:outline-none focus:border-white transition-colors text-base sm:text-lg"
          />

          <input
            type="text"
            name="apellido"
            placeholder="Apellidos"
            required
            minlength="2"
            maxlength="100"
            autocomplete="family-name"
            class="w-full bg-transparent border-b-2 border-white/60 text-white placeholder-white/80 py-2 sm:py-3 focus:outline-none focus:border-white transition-colors text-base sm:text-lg"
          />

          <input
            type="email"
            name="correo"
            placeholder="Correo electrónico"
            required
            maxlength="100"
            autocomplete="email"
            class="w-full bg-transparent border-b-2 border-white/60 text-white placeholder-white/80 py-2 sm:py-3 focus:outline-none focus:border-white transition-colors text-base sm:text-lg"
          />

          <input
            type="tel"
            name="telefono"
            placeholder="Teléfono (10 dígitos)"
            required
            pattern="[0-9]{10}"
            minlength="10"
            maxlength="10"
            title="Por favor ingresa 10 dígitos"
            autocomplete="tel"
            inputmode="numeric"
            class="w-full bg-transparent border-b-2 border-white/60 text-white placeholder-white/80 py-2 sm:py-3 focus:outline-none focus:border-white transition-colors text-base sm:text-lg"
          />

          <div class="relative">
            <select
              id="plantel_select"
              name="plantel_interes"
              required
              class="w-full bg-transparent border-b-2 border-white/60 text-white py-2 sm:py-3 focus:outline-none focus:border-white transition-colors text-base sm:text-lg appearance-none cursor-pointer [&>option]:text-gray-900 [&>option]:bg-white"
            >
              <option value="" disabled selected>Selecciona un nivel educativo</option>
              {
                niveles.map((nivel) => (
                  <option value={nivel}>{nivel}</option>
                ))
              }
            </select>
            <ChevronDown
              className="absolute right-0 top-1/2 -translate-y-1/2 w-4 h-4 sm:w-5 sm:h-5 text-white/80 pointer-events-none"
            />
          </div>

          <div
            id="programa-wrapper"
            class="hidden opacity-0 translate-y-2 transition-all duration-300"
          >
            <input
              type="text"
              name="programa_interes"
              placeholder="¿Qué carrera te interesa?"
              maxlength="200"
              autocomplete="off"
              class="w-full bg-transparent border-b-2 border-white/60 text-white placeholder-white/80 py-2 sm:py-3 focus:outline-none focus:border-white transition-colors text-base sm:text-lg"
            />
          </div>

          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-white text-[#001A71] hover:bg-gray-100  py-3 sm:py-4 px-6 sm:px-8 rounded transition-all duration-200 text-base sm:text-lg shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed mt-4 flex items-center justify-center gap-2"
          >
            <span id="btn-text">Enviar información</span>
            <svg
              id="loading-spinner"
              class="hidden animate-spin h-5 w-5"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </button>
        </form>
      </div>
    </div>
  </div>
</section>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.3s ease-out;
  }

  /* Ensure form inputs are readable on mobile */
  @media (max-width: 640px) {
    input,
    select {
      font-size: 16px !important; /* Prevents zoom on iOS */
    }
  }
</style>

<script>
  const WHATSAPP_NUMBER = "3380000863";
  const TIMEOUT_MS = 15000; // Increased to 15 seconds for better reliability

  type MessageType = "error" | "success" | "warning" | "info";

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("contact-form") as HTMLFormElement;
    const plantelSelect = document.getElementById(
      "plantel_select"
    ) as HTMLSelectElement;
    const programaWrapper = document.getElementById("programa-wrapper");
    const submitBtn = document.getElementById(
      "submit-btn"
    ) as HTMLButtonElement;
    const btnText = document.getElementById("btn-text");
    const loadingSpinner = document.getElementById("loading-spinner");
    const messageContainer = document.getElementById("message-container");
    const messageContent = document.getElementById("message-content");
    const messageText = document.getElementById("message-text");
    const messageIcon = document.getElementById("message-icon");
    const retryBtn = document.getElementById("retry-btn");

    if (!form || !plantelSelect || !programaWrapper || !submitBtn) return;

    let lastFormData: FormData | null = null;

    // ============================================
    // SECURITY: Input Sanitization Functions
    // ============================================

    /**
     * Sanitize text input to prevent XSS and code injection
     * Removes HTML tags, script tags, and dangerous characters
     */
    const sanitizeText = (input: string): string => {
      if (!input || typeof input !== "string") return "";

      // Remove HTML tags and script content
      let sanitized = input
        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, "")
        .replace(/<[^>]+>/g, "")
        .replace(/javascript:/gi, "")
        .replace(/on\w+\s*=/gi, "");

      // Trim and limit length
      sanitized = sanitized.trim().slice(0, 200);

      return sanitized;
    };

    /**
     * Validate and sanitize email
     */
    const sanitizeEmail = (email: string): string => {
      if (!email || typeof email !== "string") return "";

      const sanitized = sanitizeText(email).toLowerCase();

      // Basic email validation
      const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;
      if (!emailRegex.test(sanitized)) {
        throw new Error("Formato de correo electrónico inválido");
      }

      return sanitized.slice(0, 100);
    };

    /**
     * Validate and sanitize phone number
     */
    const sanitizePhone = (phone: string): string => {
      if (!phone || typeof phone !== "string") return "";

      // Remove all non-numeric characters
      const sanitized = phone.replace(/\D/g, "");

      // Validate 10 digits
      if (sanitized.length !== 10) {
        throw new Error("El teléfono debe tener exactamente 10 dígitos");
      }

      return sanitized;
    };

    /**
     * Validate plantel selection against allowed list
     */
    const validatePlantel = (plantel: string): string => {
      const allowedPlanteles = [
       "Bachillerato",
       "Licenciatura",
       "Posgrado",
      ];

      if (!allowedPlanteles.includes(plantel)) {
        throw new Error("Nivel educativo no válido");
      }

      return plantel;
    };

    /**
     * Validate all form data before submission
     */
    const validateFormData = (formData: FormData): boolean => {
      try {
        const nombre = formData.get("nombre") as string;
        const apellido = formData.get("apellido") as string;
        const correo = formData.get("correo") as string;
        const telefono = formData.get("telefono") as string;
        const plantel = formData.get("plantel_interes") as string;

        // Check required fields
        if (!nombre || !apellido || !correo || !telefono || !plantel) {
          showMessage(
            "Por favor completa todos los campos requeridos",
            "error"
          );
          return false;
        }

        // Validate lengths
        if (nombre.length < 2 || nombre.length > 100) {
          showMessage("El nombre debe tener entre 2 y 100 caracteres", "error");
          return false;
        }

        if (apellido.length < 2 || apellido.length > 100) {
          showMessage(
            "Los apellidos deben tener entre 2 y 100 caracteres",
            "error"
          );
          return false;
        }

        // Validate email format
        sanitizeEmail(correo);

        // Validate phone format
        sanitizePhone(telefono);

        // Validate plantel
        validatePlantel(plantel);

        return true;
      } catch (error: any) {
        showMessage(error.message || "Error de validación", "error");
        return false;
      }
    };

    // Show message to user
    const showMessage = (
      message: string,
      type: MessageType = "info",
      showRetry: boolean = false
    ) => {
      if (
        !messageContainer ||
        !messageContent ||
        !messageText ||
        !messageIcon ||
        !retryBtn
      )
        return;

      // Set message text
      messageText.textContent = message;

      // Set icon and colors based on type
      const iconClasses = "w-5 h-5 sm:w-6 sm:h-6 flex-shrink-0";
      let bgColor = "";
      let textColor = "";
      let iconSvg = "";

      switch (type) {
        case "error":
          bgColor = "bg-red-500/90";
          textColor = "text-white";
          iconSvg = `<svg class="${iconClasses}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
          break;
        case "success":
          bgColor = "bg-green-500/90";
          textColor = "text-white";
          iconSvg = `<svg class="${iconClasses}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
          break;
        case "warning":
          bgColor = "bg-yellow-500/90";
          textColor = "text-gray-900";
          iconSvg = `<svg class="${iconClasses}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>`;
          break;
        default:
          bgColor = "bg-blue-500/90";
          textColor = "text-white";
          iconSvg = `<svg class="${iconClasses}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`;
      }

      messageContent.className = `rounded-lg p-4 flex items-start gap-3 animate-fade-in ${bgColor} ${textColor}`;
      messageIcon.innerHTML = iconSvg;

      // Show/hide retry button
      if (showRetry) {
        retryBtn.classList.remove("hidden");
      } else {
        retryBtn.classList.add("hidden");
      }

      // Show message container
      messageContainer.classList.remove("hidden");

      // Auto-hide success messages after 5 seconds
      if (type === "success") {
        setTimeout(() => {
          messageContainer.classList.add("hidden");
        }, 5000);
      }
    };

    // Hide message
    const hideMessage = () => {
      if (messageContainer) {
        messageContainer.classList.add("hidden");
      }
    };

    // Show loading state
    const setLoading = (isLoading: boolean) => {
      if (isLoading) {
        submitBtn.setAttribute("disabled", "true");
        btnText!.textContent = "Enviando...";
        loadingSpinner!.classList.remove("hidden");
      } else {
        submitBtn.removeAttribute("disabled");
        btnText!.textContent = "Enviar información";
        loadingSpinner!.classList.add("hidden");
      }
    };

    // Show programa field when plantel is selected
    plantelSelect.addEventListener("change", () => {
      if (plantelSelect.value) {
        programaWrapper.classList.remove("hidden");
        setTimeout(() => {
          programaWrapper.classList.add("opacity-100", "translate-y-0");
        }, 10);
        (
          form.querySelector('[name="programa_interes"]') as HTMLInputElement
        ).required = true;
      }
    });

    // WhatsApp fallback
    const sendToWhatsApp = (formData: FormData) => {
      // Sanitize inputs before sending to WhatsApp
      const nombreRaw = formData.get("nombre") as string;
      const programaRaw =
        (formData.get("programa_interes") as string) || "Informes";
      const plantelRaw =
        (formData.get("plantel_interes") as string) || "No especificado";

      const nombre = sanitizeText(nombreRaw);
      const programa = sanitizeText(programaRaw);
      const plantel = sanitizeText(plantelRaw);

      // URL encode the sanitized values
      const msg = `Hola, intenté registrarme en la web pero hubo un problema. %0A*Nombre:* ${encodeURIComponent(nombre)}%0A*Plantel:* ${encodeURIComponent(plantel)}%0A*Interés:* ${encodeURIComponent(programa)}`;

      showMessage(
        "Redirigiendo a WhatsApp para completar tu registro...",
        "info"
      );

      setTimeout(() => {
        window.location.href = `https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`;
      }, 1500);
    };

    // Submit form
    const submitForm = async (formData: FormData) => {
      hideMessage();

      // Validate form data first
      if (!validateFormData(formData)) {
        return; // Validation failed, message already shown
      }

      setLoading(true);

      try {
        // Sanitize all inputs before processing
        const nombreRaw = formData.get("nombre") as string;
        const apellidoRaw = formData.get("apellido") as string;
        const correoRaw = formData.get("correo") as string;
        const telefonoRaw = formData.get("telefono") as string;
        const plantelRaw = formData.get("plantel_interes") as string;
        const programaRaw = (formData.get("programa_interes") as string) || "";

        // Apply sanitization
        const nombreSanitized = sanitizeText(nombreRaw);
        const apellidoCompleto = sanitizeText(apellidoRaw);
        const correoSanitized = sanitizeEmail(correoRaw);
        const telefonoSanitized = sanitizePhone(telefonoRaw);
        const plantelSanitized = validatePlantel(plantelRaw);
        const programaSanitized =
          sanitizeText(programaRaw) || "No especificado";

        // Split apellidos
        const apellidoParts = apellidoCompleto.split(/\s+/);
        const apellido_p = apellidoParts[0] || "No proporcionado";
        const apellido_m =
          apellidoParts.slice(1).join(" ") || "No proporcionado";

        // Prepare sanitized data object
        const data = {
          nombre: nombreSanitized,
          apellido_p,
          apellido_m,
          correo: correoSanitized,
          telefono: telefonoSanitized,
          medio: "Página web",
          modalidad: "Escolarizada",
          nivel_educativo: "No proporcionado",
          plantel_interes: plantelSanitized,
          programa_interes: programaSanitized,
        };

        // Timeout controller
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

        const response = await fetch(
          "https://intranet.universidad-une.com/api/createleads",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
            signal: controller.signal,
          }
        );

        clearTimeout(timeoutId);

        if (response.ok) {
          showMessage("¡Registro exitoso! Redirigiendo...", "success");
          setTimeout(() => {
            const source = form.dataset.formSource || "form_home";
            window.location.href = `/contacto/gracias/?source=${source}`;
          }, 1500);
        } else {
          // Server error
          const errorText = await response
            .text()
            .catch(() => "Error desconocido");
          console.error("Server error:", response.status, errorText);

          showMessage(
            "El servidor está experimentando problemas. ¿Deseas contactarnos por WhatsApp?",
            "error",
            true
          );
        }
      } catch (err: any) {
        console.error("Error en envío:", err);

        if (err.name === "AbortError") {
          // Timeout error
          showMessage(
            "La conexión está tardando más de lo esperado. ¿Deseas contactarnos por WhatsApp?",
            "warning",
            true
          );
        } else if (!navigator.onLine) {
          // Network offline
          showMessage(
            "No hay conexión a internet. Por favor, verifica tu conexión e intenta de nuevo.",
            "error",
            true
          );
        } else if (err.message && err.message.includes("inválido")) {
          // Validation error already shown
          return;
        } else {
          // Other errors
          showMessage(
            "Ocurrió un error al enviar el formulario. ¿Deseas contactarnos por WhatsApp?",
            "error",
            true
          );
        }
      } finally {
        setLoading(false);
      }
    };

    // Form submit handler
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      lastFormData = new FormData(form);
      await submitForm(lastFormData);
    });

    // Retry button handler - sends to WhatsApp
    retryBtn?.addEventListener("click", () => {
      if (lastFormData) {
        sendToWhatsApp(lastFormData);
      }
    });

    // Monitor online/offline status
    window.addEventListener("online", () => {
      if (messageContainer && !messageContainer.classList.contains("hidden")) {
        showMessage(
          "Conexión restaurada. Puedes intentar enviar el formulario nuevamente.",
          "success"
        );
        setTimeout(hideMessage, 3000);
      }
    });

    window.addEventListener("offline", () => {
      showMessage("Se perdió la conexión a internet.", "error");
    });
  });
</script>
