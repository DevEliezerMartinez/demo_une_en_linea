---

---

<div class="bg-gray-50 rounded-lg p-3 mb-6">
  <div class="w-full bg-gray-200 rounded-full h-1 overflow-hidden">
    <div
      class="h-1 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full transition-all duration-500 ease-out"
      id="form-progress"
      style="width: 0%"
    >
    </div>
  </div>
  <div class="mt-2 text-xs text-gray-500" id="progress-message">
    Completa los campos para continuar
  </div>
</div>

<form
  id="education-form"
  class="h-full space-y-3 lg:space-y-4 flex-1 lg:flex-none"
>
  <!-- Nombre -->
  <div>
    <input
      type="text"
      name="nombre"
      placeholder="Nombre"
      class="w-full px-2 lg:px-4 py-1.5 lg:py-2.5 border-b focus:border-blue-500 outline-none transition-colors bg-transparent text-sm lg:text-base"
      required
    />
  </div>

  <!-- Apellidos completos (un solo campo) -->
  <div class="relative">
    <input
      type="text"
      name="apellidos"
      id="apellidos-input"
      placeholder="Apellidos completos"
      class="w-full px-2 lg:px-4 py-1.5 lg:py-2.5 border-b focus:border-blue-500 outline-none transition-colors bg-transparent text-sm lg:text-base"
      required
    />
    <!-- Campos ocultos para los apellidos separados -->
    <input type="hidden" name="apellido_p" id="apellido_p_hidden" />
    <input type="hidden" name="apellido_m" id="apellido_m_hidden" />
  </div>

  <!-- Correo electr√≥nico con autocompletado -->
  <div class="relative">
    <input
      type="email"
      name="correo"
      id="correo-input"
      placeholder="Correo electr√≥nico"
      class="w-full px-2 lg:px-4 py-1.5 lg:py-2.5 border-b focus:border-blue-500 outline-none transition-colors bg-transparent text-sm lg:text-base"
      autocomplete="off"
    />
    <!-- Lista de sugerencias -->
    <div
      id="email-suggestions"
      class="absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-md shadow-lg z-50 hidden max-h-40 overflow-y-auto"
    >
    </div>
  </div>

  <!-- Tel√©fono -->
  <div>
    <input
      type="tel"
      name="telefono"
      placeholder="Tel√©fono"
      class="w-full px-2 lg:px-4 py-1.5 lg:py-2.5 border-b focus:border-blue-500 outline-none transition-colors bg-transparent text-sm lg:text-base"
      required
    />
  </div>

  <!-- Nivel educativo -->
  <div>
    <label class="text-xs lg:text-sm text-gray-600 mb-2 block"
      >Nivel educativo</label
    >
    <select
      name="nivelEducativo"
      id="nivel-educativo"
      class="w-full px-2 lg:px-4 py-1.5 lg:py-2.5 border-b focus:border-blue-500 outline-none transition-colors bg-transparent text-gray-500 text-sm lg:text-base"
      required
    >
      <option value="">Selecciona una opci√≥n</option>
    </select>
  </div>

  <!-- Programa de inter√©s -->
  <div id="programa-container">
    <label class="text-xs lg:text-sm text-gray-600 mb-2 block"
      >Programa de inter√©s</label
    >
    <select
      name="programaInteres"
      id="programa-interes"
      class="w-full px-2 lg:px-4 py-1.5 lg:py-2.5 border-b focus:border-blue-500 outline-none transition-colors bg-transparent text-gray-500 text-sm lg:text-base"
    >
      <option value="">Selecciona una opci√≥n</option>
    </select>
  </div>

  <!-- Bot√≥n de env√≠o -->
  <div class="pt-2 lg:pt-4">
    <button
      type="submit"
      class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 lg:py-3 px-6 rounded-md transition-all duration-300 text-sm lg:text-base disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden"
      aria-label="ENVIAR"
      title="ENVIAR"
      id="submit-button"
    >
      <span id="button-text">COMPLETAR REGISTRO</span>
      <div
        class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-0 transform -skew-x-12 group-hover:opacity-20 transition-all duration-700"
        id="button-shine"
      >
      </div>
    </button>
  </div>
</form>

<script>
  import { buscarOfertas } from "@/helpers/oferta_educativa.js";

  const nivelSelect = document.getElementById("nivel-educativo");
  const programaSelect = document.getElementById("programa-interes");
  const form = document.getElementById("education-form");

  // Configuraci√≥n de timeout
  const TIMEOUT_MS = 15000;

  // Configuraci√≥n de mensajes de progreso
  const messages = {
    0: {
      text: "",
      message: "Completa tus datos personales",
    },
    20: {
      text: "¬°Buen comienzo! üëè",
      message: "Sigue completando tus datos",
    },
    40: {
      text: "¬°Vas muy bien! ‚≠ê",
      message: "Ya casi tienes la mitad",
    },
    60: {
      text: "¬°Excelente progreso! üéØ",
      message: "Solo faltan unos campos m√°s",
    },
    80: {
      text: "¬°Casi listo! üî•",
      message: "Un √∫ltimo esfuerzo",
    },
    100: {
      text: "¬°Perfecto! ‚úÖ",
      message: "Todo listo para enviar",
    },
  };

  // Elementos del formulario para seguimiento
  const formInputs = [
    document.querySelector('input[name="nombre"]'),
    document.getElementById("apellidos-input"),
    document.getElementById("correo-input"),
    document.querySelector('input[name="telefono"]'),
    nivelSelect,
    programaSelect,
  ];

  const progressBar = document.getElementById("form-progress");
  const progressMessage = document.getElementById("progress-message");

  const updateProgress = () => {
    if (!progressBar || !progressMessage) return;

    let filledFields = 0;
    // Filtramos inputs nulos (por si alguno no se encuentra)
    const activeInputs = formInputs.filter((i) => i !== null);
    const totalFields = activeInputs.length || 6;

    activeInputs.forEach((input) => {
      // @ts-ignore
      if (input.value && input.value.trim() !== "") {
        filledFields++;
      }
    });

    const progress = Math.round((filledFields / totalFields) * 100);

    // Actualizar barra de progreso
    progressBar.style.width = `${progress}%`;

    // Calcular mensaje basado en el progreso
    const messageKeys = Object.keys(messages)
      .map(Number)
      .sort((a, b) => b - a);
    const currentKey = messageKeys.find((key) => progress >= key) || 0;
    const currentMessage = messages[currentKey];

    // Actualizar texto del mensaje
    const textPart = currentMessage.text
      ? `<span class="font-semibold text-blue-600 block sm:inline mr-1">${currentMessage.text}</span>`
      : "";
    progressMessage.innerHTML = `${textPart}${currentMessage.message}`;
  };

  // Agregar listeners para actualizar progreso
  formInputs.forEach((input) => {
    if (input) {
      input.addEventListener("input", updateProgress);
      input.addEventListener("change", updateProgress);
      input.addEventListener("blur", updateProgress);
    }
  });

  // Inicializar estado
  updateProgress();

  // ----------------------------------------------------------------
  // L√ìGICA DE AUTOCOMPLETADO DE CORREO
  // ----------------------------------------------------------------
  const emailInput = document.getElementById("correo-input");
  const suggestionsDiv = document.getElementById("email-suggestions");
  const commonDomains = [
    "gmail.com",
    "hotmail.com",
    "outlook.com",
    "yahoo.com",
    "live.com",
    "icloud.com",
  ];

  if (emailInput && suggestionsDiv) {
    emailInput.addEventListener("input", (e) => {
      // @ts-ignore
      const value = e.target.value;
      const atIndex = value.indexOf("@");

      if (atIndex !== -1) {
        const username = value.substring(0, atIndex);
        const domainPart = value.substring(atIndex + 1);

        const matchingDomains = commonDomains.filter((domain) =>
          domain.startsWith(domainPart),
        );

        if (matchingDomains.length > 0 && username.length > 0) {
          suggestionsDiv.innerHTML = "";
          matchingDomains.forEach((domain) => {
            const div = document.createElement("div");
            div.className =
              "px-4 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-700 transition-colors";
            div.textContent = `${username}@${domain}`;

            // Usamos mousedown para evitar conflicto con blur
            div.addEventListener("mousedown", (e) => {
              e.preventDefault();
              // @ts-ignore
              emailInput.value = `${username}@${domain}`;
              suggestionsDiv.classList.add("hidden");
              // Disparar input para validaci√≥n y barra de progreso
              emailInput.dispatchEvent(new Event("input"));
            });

            suggestionsDiv.appendChild(div);
          });
          suggestionsDiv.classList.remove("hidden");
        } else {
          suggestionsDiv.classList.add("hidden");
        }
      } else {
        suggestionsDiv.classList.add("hidden");
      }
    });

    // Ocultar sugerencias al perder foco
    emailInput.addEventListener("blur", () => {
      // Peque√±o delay por si el usuario interact√∫a con scrollbar u otro elemento
      setTimeout(() => {
        suggestionsDiv.classList.add("hidden");
      }, 200);
    });
  }

  // ----------------------------------------------------------------
  // SEPARAR APELLIDOS AUTOM√ÅTICAMENTE
  // ----------------------------------------------------------------
  const apellidosInput = document.getElementById("apellidos-input");
  const apellidoPHidden = document.getElementById("apellido_p_hidden");
  const apellidoMHidden = document.getElementById("apellido_m_hidden");

  if (apellidosInput && apellidoPHidden && apellidoMHidden) {
    apellidosInput.addEventListener("input", (e) => {
      // @ts-ignore
      const apellidosCompleto = e.target.value.trim();
      const apellidoParts = apellidosCompleto.split(/\s+/);

      // @ts-ignore
      apellidoPHidden.value = apellidoParts[0] || "";
      // @ts-ignore
      apellidoMHidden.value = apellidoParts.slice(1).join(" ") || "";
    });
  }

  // ----------------------------------------------------------------
  // L√ìGICA DE NIVEL EDUCATIVO Y PROGRAMA
  // ----------------------------------------------------------------
  if (nivelSelect && programaSelect) {
    // 1. Obtener todas las ofertas activas
    const ofertas = buscarOfertas();
    // Extraer niveles √∫nicos
    const niveles = [...new Set(ofertas.map((o) => o.programa.nivel))];

    // Funci√≥n helper para formatear texto (capitalizar)
    const formatLabel = (str) => {
      if (!str) return "";
      // Mapeo espec√≠fico si es necesario, o gen√©rico:
      const mapa = {
        licenciatura: "Licenciatura",
        maestria: "Maestr√≠a",
        doctorado: "Doctorado",
        especialidad: "Especialidad",
        bachillerato: "Bachillerato",
      };
      return mapa[str] || str.charAt(0).toUpperCase() + str.slice(1);
    };

    // Ordenar y popular el select de niveles
    niveles.sort().forEach((nivel) => {
      const option = document.createElement("option");
      option.value = nivel;
      option.textContent = formatLabel(nivel);
      nivelSelect.appendChild(option);
    });

    // 2. Listener para cambios en nivel
    nivelSelect.addEventListener("change", (e) => {
      // @ts-ignore
      const nivelSeleccionado = e.target.value;
      const programaContainer = document.getElementById("programa-container");

      // Resetear el select de programas
      programaSelect.innerHTML =
        '<option value="">Selecciona una opci√≥n</option>';

      // Asegurar visibilidad por defecto antes de aplicar l√≥gica
      if (programaContainer) programaContainer.style.display = "block";

      if (nivelSeleccionado) {
        // Buscar ofertas filtradas por nivel
        const ofertasFiltradas = buscarOfertas({ nivel: nivelSeleccionado });

        // Extraer programas √∫nicos (usando Map por id para evitar duplicados)
        const programasMap = new Map();
        ofertasFiltradas.forEach((oferta) => {
          if (!programasMap.has(oferta.programa.id)) {
            programasMap.set(oferta.programa.id, oferta.programa);
          }
        });

        const programas = Array.from(programasMap.values());
        // Ordenar alfab√©ticamente
        programas.sort((a, b) => a.nombre.localeCompare(b.nombre));

        // Popular el select de programas
        programas.forEach((prog) => {
          const option = document.createElement("option");
          option.value = prog.id;
          option.textContent = prog.nombre;
          programaSelect.appendChild(option);
        });

        // Si es Bachillerato, ocultar el campo de programa y seleccionar autom√°ticamente
        if (nivelSeleccionado === "bachillerato") {
          if (programaContainer) programaContainer.style.display = "none";
          // Seleccionar la opci√≥n de bachillerato autom√°ticamente
          // Como ya filtramos por nivel bachillerato, deber√≠a estar en las opciones
          if (programas.some((p) => p.id === "bachillerato")) {
            programaSelect.value = "bachillerato";
            // Disparar evento change manualmente por si hay otras validaciones
            programaSelect.dispatchEvent(new Event("change"));
          }
        }
      }

      // Actualizar progreso despu√©s de cambiar nivel
      updateProgress();
    });

    // Actualizar progreso cuando cambie el programa
    programaSelect.addEventListener("change", updateProgress);
  }

  // ----------------------------------------------------------------
  // FUNCIONES DE SANITIZACI√ìN
  // ----------------------------------------------------------------
  const sanitizeText = (text) => {
    if (!text) return "";
    return text.trim().replace(/[<>]/g, "").substring(0, 100);
  };

  const sanitizeEmail = (email) => {
    if (!email) return "";
    const sanitized = email.trim().toLowerCase();
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(sanitized)) {
      throw new Error("Correo inv√°lido");
    }
    return sanitized;
  };

  const sanitizePhone = (phone) => {
    if (!phone) return "";
    const cleaned = phone.replace(/\D/g, "");
    if (cleaned.length < 10) {
      throw new Error("Tel√©fono inv√°lido");
    }
    return cleaned.substring(0, 15);
  };

  // ----------------------------------------------------------------
  // FUNCIONES DE VALIDACI√ìN
  // ----------------------------------------------------------------
  const validateFormData = (formData) => {
    const nombre = formData.get("nombre");
    const apellidos = formData.get("apellidos");
    const correo = formData.get("correo");
    const telefono = formData.get("telefono");
    const nivelEducativo = formData.get("nivelEducativo");
    const programaInteres = formData.get("programaInteres");

    if (!nombre || !nombre.toString().trim()) {
      showMessage("Por favor ingresa tu nombre", "error");
      return false;
    }

    if (!apellidos || !apellidos.toString().trim()) {
      showMessage("Por favor ingresa tus apellidos", "error");
      return false;
    }

    if (!correo || !correo.toString().trim()) {
      showMessage("Por favor ingresa tu correo electr√≥nico", "error");
      return false;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(correo.toString().trim())) {
      showMessage("Por favor ingresa un correo electr√≥nico v√°lido", "error");
      return false;
    }

    if (!telefono || !telefono.toString().trim()) {
      showMessage("Por favor ingresa tu tel√©fono", "error");
      return false;
    }

    const phoneClean = telefono.toString().replace(/\D/g, "");
    if (phoneClean.length < 10) {
      showMessage(
        "Por favor ingresa un tel√©fono v√°lido (m√≠nimo 10 d√≠gitos)",
        "error",
      );
      return false;
    }

    if (!nivelEducativo || !nivelEducativo.toString().trim()) {
      showMessage("Por favor selecciona tu nivel educativo", "error");
      return false;
    }

    // Validar programa solo si no es bachillerato
    const nivelValue = nivelEducativo.toString().trim();
    if (nivelValue !== "bachillerato") {
      if (!programaInteres || !programaInteres.toString().trim()) {
        showMessage("Por favor selecciona un programa de inter√©s", "error");
        return false;
      }
    }

    return true;
  };

  // ----------------------------------------------------------------
  // FUNCIONES DE MENSAJE Y UI
  // ----------------------------------------------------------------
  let messageTimeout;

  const showMessage = (text, type = "info", showWhatsApp = false) => {
    hideMessage();

    const messageDiv = document.createElement("div");
    messageDiv.id = "form-message";
    messageDiv.className = `fixed top-4 right-4 left-4 md:left-auto md:w-96 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${
      type === "success"
        ? "bg-green-500 text-white"
        : type === "error"
          ? "bg-red-500 text-white"
          : type === "warning"
            ? "bg-yellow-500 text-white"
            : "bg-blue-500 text-white"
    }`;

    const textSpan = document.createElement("p");
    textSpan.textContent = text;
    textSpan.className = "mb-2";
    messageDiv.appendChild(textSpan);

    if (showWhatsApp) {
      const whatsappBtn = document.createElement("a");
      whatsappBtn.href = "https://wa.me/523331234567"; // Ajusta el n√∫mero
      whatsappBtn.target = "_blank";
      whatsappBtn.className =
        "inline-block mt-2 px-4 py-2 bg-white text-green-600 rounded-md font-semibold hover:bg-gray-100 transition-colors";
      whatsappBtn.textContent = "Contactar por WhatsApp";
      messageDiv.appendChild(whatsappBtn);
    }

    document.body.appendChild(messageDiv);

    if (!showWhatsApp) {
      messageTimeout = setTimeout(() => {
        hideMessage();
      }, 5000);
    }
  };

  const hideMessage = () => {
    const existingMessage = document.getElementById("form-message");
    if (existingMessage) {
      existingMessage.remove();
    }
    if (messageTimeout) {
      clearTimeout(messageTimeout);
    }
  };

  const setLoading = (loading) => {
    const submitButton = document.getElementById("submit-button");
    const buttonText = document.getElementById("button-text");

    if (submitButton && buttonText) {
      if (loading) {
        // @ts-ignore
        submitButton.disabled = true;
        submitButton.classList.add("opacity-50", "cursor-not-allowed");
        buttonText.textContent = "ENVIANDO...";
      } else {
        // @ts-ignore
        submitButton.disabled = false;
        submitButton.classList.remove("opacity-50", "cursor-not-allowed");
        buttonText.textContent = "COMPLETAR REGISTRO";
      }
    }
  };

  // ----------------------------------------------------------------
  // FUNCI√ìN DE ENV√çO DEL FORMULARIO
  // ----------------------------------------------------------------
  const submitForm = async (formData) => {
    hideMessage();

    // Validate form data first
    if (!validateFormData(formData)) {
      return; // Validation failed, message already shown
    }

    setLoading(true);

    try {
      // Sanitize all inputs before processing
      const nombreRaw = formData.get("nombre");
      const apellidosRaw = formData.get("apellidos");
      const correoRaw = formData.get("correo");
      const telefonoRaw = formData.get("telefono");
      const nivelEducativoRaw = formData.get("nivelEducativo");
      const programaInteresRaw = formData.get("programaInteres");

      // Apply sanitization
      const nombreSanitized = sanitizeText(nombreRaw);
      const apellidosCompleto = sanitizeText(apellidosRaw);
      const correoSanitized = sanitizeEmail(correoRaw);
      const telefonoSanitized = sanitizePhone(telefonoRaw);
      const nivelEducativoSanitized = sanitizeText(nivelEducativoRaw);
      const programaInteresSanitized =
        sanitizeText(programaInteresRaw) || "No especificado";

      // Split apellidos (los campos ocultos ya tienen los valores)
      const apellido_p = formData.get("apellido_p") || "No proporcionado";
      const apellido_m = formData.get("apellido_m") || "No proporcionado";

      // Prepare sanitized data object
      const data = {
        nombre: nombreSanitized,
        apellido_p: sanitizeText(apellido_p),
        apellido_m: sanitizeText(apellido_m),
        correo: correoSanitized,
        telefono: telefonoSanitized,
        medio: "P√°gina web - UNE en l√≠nea",
        modalidad: "Escolarizada",
        nivel_educativo: nivelEducativoSanitized,
        plantel_interes: "No especificado", // Ajusta seg√∫n tu l√≥gica
        programa_interes: programaInteresSanitized,
      };

      // Timeout controller
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

      const response = await fetch(
        "https://intranet.universidad-une.com/api/createleads",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
          signal: controller.signal,
        },
      );

      clearTimeout(timeoutId);

      if (response.ok) {
        showMessage("¬°Registro exitoso! Redirigiendo...", "success");
        setTimeout(() => {
          const source = form.dataset.formSource || "form_educativo";
          window.location.href = `/contacto/gracias/?source=${source}`;
        }, 1500);
      } else {
        // Server error
        const errorText = await response
          .text()
          .catch(() => "Error desconocido");
        console.error("Server error:", response.status, errorText);

        showMessage(
          "El servidor est√° experimentando problemas. ¬øDeseas contactarnos por WhatsApp?",
          "error",
          true,
        );
      }
    } catch (err) {
      console.error("Error en env√≠o:", err);

      if (err.name === "AbortError") {
        // Timeout error
        showMessage(
          "La conexi√≥n est√° tardando m√°s de lo esperado. ¬øDeseas contactarnos por WhatsApp?",
          "warning",
          true,
        );
      } else if (!navigator.onLine) {
        // Network offline
        showMessage(
          "No hay conexi√≥n a internet. Por favor, verifica tu conexi√≥n e intenta de nuevo.",
          "error",
          true,
        );
      } else if (err.message && err.message.includes("inv√°lido")) {
        // Validation error already shown
        return;
      } else {
        // Other errors
        showMessage(
          "Ocurri√≥ un error al enviar el formulario. ¬øDeseas contactarnos por WhatsApp?",
          "error",
          true,
        );
      }
    } finally {
      setLoading(false);
    }
  };

  // ----------------------------------------------------------------
  // EVENT LISTENER DEL FORMULARIO
  // ----------------------------------------------------------------
  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      await submitForm(formData);
    });
  }
</script>
