---
import { ofertaEducativa, buscarOfertas } from "@/helpers/oferta_educativa";
import { getImageUrl } from "@/helpers/imageManager.js";

const carreras = buscarOfertas({ nivel: "licenciatura" }).map((oferta) => {
  const { programa, incorporacion } = oferta;
  const imagenNombre = programa.imagen || programa.nombre;
  const areaInfo = ofertaEducativa.areas[programa.area];
  const areaNombre = areaInfo ? areaInfo.nombre : programa.area;

  return {
    id: programa.id,
    nombre: `Lic. en ${programa.nombre}`,
    descripcion: programa.descripcion,
    area: areaNombre,
    imagenNombre,
    imagenUrl: getImageUrl(imagenNombre, "licenciaturas"),
    incorporacion: incorporacion.nombre,
    // Refinamiento: Badge UDG con borde para mejor contraste
    colorBadge:
      incorporacion.id === "udg"
        ? "bg-red-600 ring-2 ring-white"
        : "bg-blue-700 ring-2 ring-white",
    url: programa.url || `/oferta/licenciaturas/${programa.id}`,
    tieneUDG: incorporacion.id === "udg",
  };
});

const areas = ["Todas", ...new Set(carreras.map((c) => c.area))];
---

<div class="max-w-7xl mx-auto px-4 py-12">
  <header class="mb-10 text-center md:text-left">
    <h1
      class="text-4xl md:text-5xl font-semibold text-gray-900 tracking-tight mb-4"
    >
      OFERTA ACAD√âMICA
    </h1>
    <p class="text-lg text-gray-600 max-w-2xl">
      Explora nuestras licenciaturas y encuentra el futuro profesional que
      buscas.
    </p>
  </header>

  <div class="relative mb-8">
    <label for="search-input" class="sr-only">Buscar licenciatura</label>
    <div class="relative">
      <input
        type="text"
        id="search-input"
        placeholder="Escribe el nombre de la carrera..."
        class="w-full px-5 py-4 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
        autocomplete="off"
      />
      <div class="absolute right-4 top-4 text-gray-400">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <div
      id="autocomplete-dropdown"
      class="absolute z-20 w-full bg-white border border-gray-200 rounded-b-xl hidden shadow-xl max-h-64 overflow-y-auto mt-1"
    >
    </div>
  </div>

  <nav class="flex flex-wrap gap-2 mb-8" aria-label="Filtros por √°rea">
    {
      areas.map((area, index) => (
        <button
          class={`tab-button px-5 py-2.5 rounded-full text-sm  whitespace-nowrap transition-all duration-200 ${
            index === 0
              ? "bg-blue-600 text-white shadow-md"
              : "bg-gray-100 text-gray-600 hover:bg-gray-200"
          }`}
          data-area={area}
          role="tab"
          aria-selected={index === 0 ? "true" : "false"}
        >
          {area}
        </button>
      ))
    }
  </nav>

  <section class="relative">
    <div
      id="cards-container"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10"
    >
      {
        carreras.map((carrera) => (
          <article
            class="career-card group bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-2xl transition-all duration-300 flex flex-col"
            data-area={carrera.area}
            data-name={carrera.nombre.toLowerCase()}
          >
            <div class="relative overflow-hidden aspect-video">
              <img
                src={carrera.imagenUrl}
                alt={`Imagen representativa de ${carrera.nombre}`}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                loading="lazy"
              />
              {carrera.tieneUDG && (
                <span
                  class={`absolute top-4 right-4 ${carrera.colorBadge} text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm`}
                >
                  UDG
                </span>
              )}
            </div>

            <div class="p-6 flex flex-col flex-grow">
              <h3 class="mb-3 text-xl font-bold text-gray-900 leading-tight">
                {carrera.nombre}
              </h3>
              <p class="text-gray-600 text-sm mb-6 line-clamp-3 flex-grow">
                {carrera.descripcion}
              </p>

              <div class="mt-auto space-y-4">
                <span class="inline-block bg-blue-50 text-blue-700 font-bold px-3 py-1 text-[10px] uppercase tracking-wider rounded-md">
                  {carrera.incorporacion}
                </span>

                <a
                  href={carrera.url}
                  target="_blank"
                  class="w-full bg-red-600 text-white py-3 px-4 rounded-xl font-bold hover:bg-red-700 active:scale-95 transition-all block text-center shadow-sm"
                >
                  M√ÅS INFORMACI√ìN
                </a>
              </div>
            </div>
          </article>
        ))
      }
    </div>

    <div id="no-results" class="hidden text-center py-20">
      <div class="text-6xl mb-4">üîç</div>
      <h3 class="text-xl font-bold text-gray-900">No encontramos resultados</h3>
      <p class="text-gray-500">
        Intenta con otra palabra clave o cambia el filtro de √°rea.
      </p>
    </div>

    <div class="md:hidden text-center">
      <button
        id="show-more-btn"
        class="w-full bg-white border-2 border-blue-600 text-blue-600 px-6 py-4 rounded-xl font-bold hover:bg-blue-50 transition-colors"
      >
        Ver m√°s carreras
      </button>
    </div>
  </section>
</div>

<script define:vars={{ carreras }}>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("search-input");
    const autocompleteDropdown = document.getElementById(
      "autocomplete-dropdown",
    );
    const tabButtons = document.querySelectorAll(".tab-button");
    const careerCards = document.querySelectorAll(".career-card");
    const showMoreBtn = document.getElementById("show-more-btn");
    const noResults = document.getElementById("no-results");

    let currentArea = "Todas";
    let selectedName = "";
    let visibleCards = 3;

    function showCards() {
      const isMobile = window.innerWidth < 768;
      let visibleCount = 0;
      let totalMatches = 0;

      careerCards.forEach((card) => {
        const cardArea = card.getAttribute("data-area");
        const cardName = card.getAttribute("data-name");

        const matchesArea = currentArea === "Todas" || cardArea === currentArea;
        const matchesSearch = !selectedName || cardName === selectedName;
        const shouldShow = matchesArea && matchesSearch;

        if (shouldShow) {
          totalMatches++;
          if (isMobile && visibleCount >= visibleCards) {
            card.classList.add("hidden");
          } else {
            card.classList.remove("hidden");
            visibleCount++;
          }
        } else {
          card.classList.add("hidden");
        }
      });

      // Manejo de estados visuales
      noResults.classList.toggle("hidden", totalMatches > 0);

      const hasMoreToLoad = isMobile && totalMatches > visibleCards;
      showMoreBtn.classList.toggle("hidden", !hasMoreToLoad);
    }

    // Autocomplete Logic
    searchInput.addEventListener("input", function (e) {
      const query = e.target.value.toLowerCase();
      if (query.length < 2) {
        autocompleteDropdown.classList.add("hidden");
        if (query.length === 0) {
          selectedName = "";
          showCards();
        }
        return;
      }

      const matches = carreras.filter((c) =>
        c.nombre.toLowerCase().includes(query),
      );

      if (matches.length > 0) {
        autocompleteDropdown.innerHTML = matches
          .map(
            (c) => `
          <div class="px-4 py-3 hover:bg-blue-50 cursor-pointer transition-colors border-b border-gray-50 last:border-none" data-val="${c.nombre.toLowerCase()}">
            <span class="font-medium">${c.nombre}</span>
          </div>
        `,
          )
          .join("");
        autocompleteDropdown.classList.remove("hidden");
      } else {
        autocompleteDropdown.classList.add("hidden");
      }
    });

    autocompleteDropdown.addEventListener("click", function (e) {
      const item = e.target.closest("[data-val]");
      if (item) {
        searchInput.value = item.querySelector("span").textContent;
        selectedName = item.getAttribute("data-val");
        autocompleteDropdown.classList.add("hidden");
        showCards();
      }
    });

    // Filtros por Tabs
    tabButtons.forEach((button) => {
      button.addEventListener("click", function () {
        tabButtons.forEach((btn) => {
          btn.classList.replace("bg-blue-600", "bg-gray-100");
          btn.classList.replace("text-white", "text-gray-600");
          btn.classList.remove("shadow-md");
          btn.setAttribute("aria-selected", "false");
        });

        this.classList.replace("bg-gray-100", "bg-blue-600");
        this.classList.replace("text-gray-600", "text-white");
        this.classList.add("shadow-md");
        this.setAttribute("aria-selected", "true");

        currentArea = this.getAttribute("data-area");
        visibleCards = 3;
        showCards();
      });
    });

    showMoreBtn.addEventListener("click", () => {
      visibleCards += 3;
      showCards();
    });

    // Cerrar dropdown al clickear fuera
    document.addEventListener("click", (e) => {
      if (!searchInput.contains(e.target))
        autocompleteDropdown.classList.add("hidden");
    });

    showCards();
  });
</script>

<style>
  .career-card {
    animation: slideUp 0.4s ease-out forwards;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
