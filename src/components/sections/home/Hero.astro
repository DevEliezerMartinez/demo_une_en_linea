---
// src/components/MainSlider.astro
import { Image } from "astro:assets";
import { ArrowRight } from "lucide-astro";

// Importar imágenes para optimización
import heroDesktop from "@/assets/imagenes/heros/portada3.jpg";
import heroMobile from "@/assets/imagenes/heros/portada3_mobile.jpg";
import ofertaDesktop from "@/assets/imagenes/heros/maestrias_desktop.webp";
import ofertaMobile from "@/assets/imagenes/heros/maestrias_mobile.webp";
import plataformaDesktop from "@/assets/imagenes/heros/plataforma_educativa_desktop.webp";
import plataformaMobile from "@/assets/imagenes/heros/plataforma_educativa_mobile.webp";
import modeloDesktop from "@/assets/imagenes/heros/licenciaturas_desktop.webp";
import modeloMobile from "@/assets/imagenes/heros/licenciaturas_mobile.webp";

const slides = [
  {
    id: 0,
    title: "MÁS CONECTADOS,",
    highlight: "MÁS CERCA DE TI",
    image: heroDesktop,
    imageMobile: heroMobile,
    subtitle:
      "Nuestra tecnología con sentido humano rompe fronteras para llevar la excelencia académica hasta tu pantalla.",
    showText: true,
    isWhiteLayout: true,
    duration: 10000,
  },
  {
    id: 1,
    title: "OFERTA ACADÉMICA",
    image: ofertaDesktop,
    imageMobile: ofertaMobile,
    subtitle:
      "Descubre nuestros programas educativos diseñados para tu éxito profesional",
    cta: { text: "Explorar oferta", href: "/oferta-academica" },
    showText: true,
    duration: 10000,
  },
  {
    id: 2,
    title: "NUESTRA PLATAFORMA",
    image: plataformaDesktop,
    imageMobile: plataformaMobile,
    subtitle:
      "Descubre nuestra plataforma educativa diseñada para tu éxito profesional",
    cta: { text: "Conocer más de UNE", href: "/acerca/plataforma" },
    showText: true,
    duration: 10000,
  },
  {
    id: 3,
    title: "Modelo educativo",
    image: modeloDesktop,
    imageMobile: modeloMobile,
    subtitle:
      "Descubre nuestro modelo educativo que combina la excelencia académica con la flexibilidad que necesitas para crecer profesionalmente a tu propio ritmo.",
    cta: { text: "Descubrir modelo", href: "/acerca/modelo-educativo" },
    showText: true,
    duration: 10000,
  },
];
---

<div class="relative w-full">
  <div id="hero-slider" class="relative h-[700px] overflow-hidden bg-white">
    <div class="slides-container relative h-full">
      {
        slides.map((slide, index) => (
          <div
            class={`slide absolute inset-0 transition-opacity duration-700 ${index === 0 ? "opacity-100 z-10" : "opacity-0 z-0"}`}
            data-slide-index={index}
          >
            {/* Imagen Desktop */}
            <Image
              src={slide.image}
              alt={slide.title}
              width={1920}
              height={700}
              format="webp"
              quality={65}
              loading={index === 0 ? "eager" : "lazy"}
              fetchpriority={index === 0 ? "high" : "low"}
              decoding={index === 0 ? "sync" : "async"}
              class="hidden md:block w-full h-full object-cover object-center"
            />

            {/* Imagen Mobile - solo si es diferente */}
            {slide.imageMobile !== slide.image && (
              <Image
                src={slide.imageMobile}
                alt={slide.title}
                width={768}
                height={700}
                format="webp"
                quality={60}
                loading={index === 0 ? "eager" : "lazy"}
                fetchpriority={index === 0 ? "high" : "low"}
                decoding={index === 0 ? "sync" : "async"}
                class="md:hidden w-full h-full object-cover object-center"
              />
            )}

            {slide.isWhiteLayout ? (
              <div class="absolute inset-0">
                <div class="absolute inset-0 bg-linear-to-r from-white/95 via-white/80 to-transparent" />
                <div class="relative z-10 max-w-7xl mx-auto px-6 lg:px-8 h-full flex items-center">
                  <div class="max-w-xl space-y-8 text-left">
                    <div class="space-y-6">
                      <h1 class="text-3xl md:text-5xl lg:text-5xl font-bold text-gray-900 leading-tight">
                        {slide.title} <br />
                        <span class="text-azul-une">{slide.highlight}</span>
                      </h1>
                      <p class="text-gray-700 text-md md:text-xl leading-relaxed">
                        {slide.subtitle}
                      </p>
                    </div>
                    <a
                      href="/acerca/oferta-academica"
                      class="inline-block bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-8 rounded-xl text-base transition-all transform hover:scale-105 shadow-xl shadow-red-500/30"
                    >
                      Descubre lo que tenemos para ti
                    </a>
                  </div>
                </div>
              </div>
            ) : (
              <div class="absolute inset-0 bg-black/30">
                <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-6">
                  <h2 class="text-white text-4xl sm:text-5xl lg:text-6xl font-bold mb-4 drop-shadow-md">
                    {slide.title}
                  </h2>
                  {slide.subtitle && (
                    <p class="text-white/90 text-lg sm:text-xl max-w-2xl mx-auto drop-shadow-sm">
                      {slide.subtitle}
                    </p>
                  )}
                  {slide.cta && (
                    <a
                      class="bg-rojo-une py-4 px-8 rounded-md mt-12 text-white hover:bg-rojo-une/90 transition-colors shadow-lg"
                      href={slide.cta.href}
                    >
                      {slide.cta.text}
                    </a>
                  )}
                </div>
              </div>
            )}
          </div>
        ))
      }
    </div>

    <div
      class="absolute bottom-0 left-0 right-0 h-32 bg-linear-to-t from-black/60 to-transparent z-20 pointer-events-none"
    >
    </div>

    <div class="absolute bottom-0 left-0 right-0 p-4 sm:p-6 lg:p-8 z-30">
      <div
        class="flex flex-col sm:flex-row items-end justify-between gap-4 sm:gap-6 w-full"
      >
        <div class="flex items-end gap-2 w-full sm:w-auto">
          <button
            id="playPauseBtn"
            class="bg-black/50 hover:bg-black/70 text-white p-2 rounded-full transition-all duration-300 backdrop-blur-sm shrink-0"
            aria-label="Pausar slider"
          >
            <svg
              id="pauseIcon"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="6" y="4" width="4" height="16"></rect>
              <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
            <svg
              id="playIcon"
              class="hidden"
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polygon points="5,3 19,12 5,21"></polygon>
            </svg>
          </button>
        </div>

        <div class="flex items-end w-full gap-2 sm:gap-4 lg:gap-6">
          {
            slides.map((slide, index) => (
              <button
                class="progress-line flex-shrink-0 flex-grow w-[16%] transition-all duration-300"
                data-slide-index={index}
                data-duration={slide.duration}
                aria-label={`Ver slide ${index + 1}: ${slide.isWhiteLayout ? "Inicio" : slide.title}`}
              >
                <h3 class="text-white text-xs md:text-sm font-semibold tracking-wider text-left mb-2 hidden lg:block uppercase opacity-90">
                  {slide.isWhiteLayout ? "Inicio" : slide.title}
                </h3>
              </button>
            ))
          }
        </div>
      </div>
    </div>
  </div>
</div>

<div
  class="full-width flex flex-col md:flex-row justify-between px-4 md:px-16 py-8 items-center md:items-start mb-16"
>
  <h2
    class="font-semibold text-3xl md:text-4xl text-center md:text-left mb-4 md:mb-0"
  >
    <span class="text-rojo-une">VIVE</span> LA MEJOR EXPERIENCIA EDUCATIVA
  </h2>
  <a
    class="cta-button flex font-normal md:font-bold text-xl md:text-2xl uppercase h-14 bg-azul-une text-white w-auto px-8 md:px-12 py-2.5 gap-8 md:gap-12 rounded-2xl group transition-all duration-300 ease-in-out justify-center md:justify-between relative overflow-hidden shadow-xl"
    href="/contacto/solicitarinformacion"
  >
    <span
      class="shine-effect absolute inset-0 -translate-x-full group-hover:translate-x-full transition-transform duration-700 ease-in-out bg-gradient-to-r from-transparent via-white/20 to-transparent"
    ></span>
    <span class="relative z-10">contáctanos</span>
    <span
      class="arrow-container border-2 border-white rounded-full p-1 group-hover:border-blue-400 group-hover:rotate-[-4deg] group-hover:scale-110 transition-all duration-300 flex items-center justify-center relative z-10"
    >
      <ArrowRight
        class="h-6 w-6 group-hover:translate-x-1 transition-transform"
      />
    </span>
  </a>
</div>

<style>
  .slide {
    will-change: opacity;
  }

  /* Progress line base (Gris traslúcido) */
  .progress-line {
    position: relative;
    cursor: pointer;
    padding-bottom: 8px;
    background: none;
    border: none;
  }

  .progress-line::before {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 1px;
    z-index: 1;
  }

  /* Active fill line (Blanco Puro) */
  .progress-line::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 3px;
    background: #ffffff;
    z-index: 2;
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease-out;
    border-radius: 1px;
  }

  .progress-line.is-active::after {
    animation: progressFill var(--slide-duration) linear forwards;
  }

  .progress-line.is-completed::after {
    transform: scaleX(1);
    animation: none;
  }
  .progress-line.is-paused::after {
    animation-play-state: paused;
  }

  @keyframes progressFill {
    from {
      transform: scaleX(0);
    }
    to {
      transform: scaleX(1);
    }
  }

  .cta-button {
    animation: subtle-pulse 3s ease-in-out infinite;
  }
  .cta-button:hover {
    animation: none;
    transform: translateY(-2px);
  }

  @keyframes subtle-pulse {
    0%,
    100% {
      box-shadow: 0 4px 14px 0 rgba(0, 118, 255, 0.39);
    }
    50% {
      box-shadow: 0 6px 25px rgba(0, 118, 255, 0.6);
    }
  }
</style>

<script>
  class HeroSlider {
    currentIndex: number;
    isPaused: boolean;
    autoplayTimer: any;
    slider: HTMLElement | null;
    slides: NodeListOf<Element>;
    progressLines: NodeListOf<Element>;
    playPauseBtn: HTMLElement | null;
    playIcon: HTMLElement | null;
    pauseIcon: HTMLElement | null;

    constructor() {
      this.currentIndex = 0;
      this.isPaused = false;
      this.autoplayTimer = null;
      this.slider = document.getElementById("hero-slider");
      this.slides = document.querySelectorAll(".slide");
      this.progressLines = document.querySelectorAll(".progress-line");
      this.playPauseBtn = document.getElementById("playPauseBtn");
      this.playIcon = document.getElementById("playIcon");
      this.pauseIcon = document.getElementById("pauseIcon");

      if (!this.slider) return;
      this.init();
    }

    init() {
      this.updateProgressBars(0);
      this.playPauseBtn?.addEventListener("click", () =>
        this.togglePlayPause(),
      );
      this.progressLines.forEach((line) => {
        line.addEventListener("click", () => {
          const index = parseInt(line.dataset.slideIndex);
          this.goToSlide(index);
        });
      });
      this.startAutoplay();
    }

    goToSlide(index) {
      if (index === this.currentIndex) return;
      this.slides[this.currentIndex]?.classList.replace(
        "opacity-100",
        "opacity-0",
      );
      this.slides[this.currentIndex]?.classList.replace("z-10", "z-0");
      this.slides[index]?.classList.replace("opacity-0", "opacity-100");
      this.slides[index]?.classList.replace("z-0", "z-10");
      this.currentIndex = index;
      this.updateProgressBars(index);
      if (!this.isPaused) this.startAutoplay();
    }

    updateProgressBars(activeIndex) {
      this.progressLines.forEach((line, index) => {
        line.classList.remove("is-active", "is-completed", "is-paused");
        line.removeAttribute("aria-current");
        if (index < activeIndex) line.classList.add("is-completed");
        else if (index === activeIndex) {
          line.classList.add("is-active");
          line.setAttribute("aria-current", "true");
          if (this.isPaused) line.classList.add("is-paused");
          const duration = parseInt(line.dataset.duration) || 10000;
          line.style.setProperty("--slide-duration", `${duration / 1000}s`);
        }
      });
    }

    startAutoplay() {
      this.clearAutoplay();
      if (this.isPaused) return;
      const duration =
        parseInt(this.progressLines[this.currentIndex]?.dataset.duration) ||
        10000;
      this.autoplayTimer = setTimeout(() => {
        this.goToSlide((this.currentIndex + 1) % this.slides.length);
      }, duration);
    }

    clearAutoplay() {
      clearTimeout(this.autoplayTimer);
    }

    togglePlayPause() {
      this.isPaused = !this.isPaused;
      this.playIcon?.classList.toggle("hidden");
      this.pauseIcon?.classList.toggle("hidden");
      if (this.isPaused) {
        this.clearAutoplay();
        this.progressLines[this.currentIndex]?.classList.add("is-paused");
        this.playPauseBtn?.setAttribute("aria-label", "Reproducir slider");
      } else {
        this.startAutoplay();
        this.progressLines[this.currentIndex]?.classList.remove("is-paused");
        this.playPauseBtn?.setAttribute("aria-label", "Pausar slider");
      }
    }
  }
  new HeroSlider();
</script>
