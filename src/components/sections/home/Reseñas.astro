---
import { Image } from 'astro:assets';
import ResenaImg from '@/assets/imagenes/testimonios.webp';

const testimonios = [
  {
    texto: "¡Hola! Mi nombre es Daniel Fernando Murguía Jiménez, egresado de la Lic. en Comunicación en Línea, y aprovecho este espacio para expresar mi reconocimiento y gratitud a todos los que conforman esta modalidad, ya que siempre estuvieron para apoyarme en mi avance. No queda más que reconocer que en Une en Línea siempre están a la vanguardia y en todo momento atentos a sus alumnos: la asesoría de las Tutoras fue de calidad, la ayuda de Soporte siempre a tiempo y la amabilidad de Control Escolar fue oportuna para resolver mis dudas. Recomiendo totalmente a Une en Línea, si tienen la oportunidad de vivir la experiencia, ¡no la desaprovechen y atrévanse a vivirla!",
    nombre: "Daniel Fernando Murguía Jiménez",
    programa: "Lic. en Comunicación"
  },
  {
    texto: "Mi nombre es Fabián Chávez De La Cruz y cursé la Licenciatura en Administración en la Universidad UNE. Quiero compartir cómo fue mi experiencia con las clases en línea durante ese tiempo. Al principio, adaptarme a esa modalidad fue todo un reto. Extrañaba la interacción presencial con mis compañeros y profesores, pero poco a poco descubrí las ventajas de estudiar desde casa: la flexibilidad de horarios, el ahorro en tiempo de traslado y la posibilidad de revisar las clases grabadas cuando lo necesitaba. Las plataformas digitales que utiliza la UNE fueron muy buenas, sobre todo el apoyo por parte de profesores y tutores siempre apoyando y enriqueciendo mi manera de ser más efectivo. Me gustó especialmente que ven si entraba a mi plataforma y si tenía alguna necesidad para apoyarme y no quedarme atrás, sobre todo siempre viendo la manera de ayudarme: los foros de discusión, los materiales multimedia, la atención de los profesores. Sin embargo, también he enfrentado desafíos como conocer mi manera de aprender y explotarla: mantener la concentración, problemas técnicos, que fui resolviendo. A nivel académico, siento que para las personas que trabajamos y estudiamos es la manera más efectiva y eficiente de aprender y de aprovechar el tiempo y sobre todo lo económico: he aprendido mucho, me costó menos trabajo aprender, desarrollé habilidades de autodisciplina. Esta experiencia me ha enseñado a ser más abierto en mi manera de aprender y sobre todo más eficiente en elegir los conocimientos que necesitaba desarrollar: a ser más organizado, a valorar el tiempo, a adaptarme a nuevas situaciones y a tener un plan de aprendizaje. En general, mi experiencia estudiando en línea en la UNE ha sido positiva, retadora, enriquecedora y estoy emocionado, comprometido, motivado por continuar mi formación profesional. Y sobre todo explotar las ventajas de estudiar en línea como lo es ahorro en libros, tiempo y en información más directa a mi forma de aprender y mi interés.",
    nombre: "Fabián Chávez De La Cruz",
    programa: "Lic. en Administración"
  },
  {
    texto: "Hola. Mi nombre es Roberto Emmanuel Pérez García, soy egresado de la Ingeniería Industrial en Línea, y quiero utilizar este medio para externar mi más sincero agradecimiento y reconocimiento a todo el equipo que hace posible esta modalidad educativa, pues su respaldo fue fundamental para mi progreso académico. Es justo destacar que Une en Línea se mantiene a la vanguardia y muestra una constante atención hacia sus estudiantes: la tutoría que recibí por parte de las asesoras fue excelente, el apoyo del área de Soporte siempre fue puntual y la cordialidad del personal de Control Escolar resultó clave para aclarar todas mis inquietudes. Recomiendo al cien por ciento a Une en Línea. Si se les presenta la oportunidad de formar parte de esta experiencia, mi consejo es que no la dejen pasar y se animen a ser parte de ella.",
    nombre: "Roberto Emmanuel Pérez García",
    programa: "Ingeniería Industrial"
  },
  {
    texto: "Hola, mi nombre es Eva Nataly Ramos Montes. Estudiar la prepa a mi edad fue un reto lleno de emociones. Al inicio sentí miedo, dudas y vergüenza por mi edad y el qué dirán por no encajar, pero también fue una experiencia bonita. Aunque sí con el tiempo apareció la confianza: comprendí que la edad suma experiencia, disciplina y enfoque. Hubo cansancio por equilibrar trabajo, familia y estudios, pero cada logro reforzó mi autoestima. Aprendí a valorar el esfuerzo propio, a pedir ayuda y a celebrar avances pequeños. Me sentí orgullosa, capaz y resiliente. Terminar confirmó que nunca es tarde para aprender, crecer y cumplir metas personales, y que mis sueños merecen constancia, paciencia, valentía y compromiso.",
    nombre: "Eva Nataly Ramos Montes",
    programa: "Bachillerato"
  },
  {
    texto: "Estudie en el centro universitario UNE, la Licenciatura en Educación. Mi experiencia al cursar la Licenciatura en Educación en la Universidad UNE fue muy satisfactoria. La modalidad virtual ofrece grandes beneficios, especialmente para quienes combinamos la vida laboral, familiar y personal con los estudios. La plataforma es rápida, segura y muy funcional, además de contar con una amplia variedad de materiales de apoyo que facilitan el aprendizaje y refuerzan los contenidos académicos. Destaco especialmente la labor de los docentes, quienes demuestran un alto nivel de profesionalismo y compromiso. Siempre se mostraron atentos a resolver dudas académicas, dando seguimiento oportuno a los mensajes y asegurando la continuidad en las respuestas, lo que genera confianza y un acompañamiento constante durante el proceso formativo. Recomiendo ampliamente esta modalidad educativa, ya que permite continuar con la preparación profesional sin descuidar otras responsabilidades. Sin duda, la educación virtual de la Universidad UNE es una excelente opción para quienes no contamos con el tiempo necesario para asistir de manera presencial.",
    nombre: "Lucia Gutiérrez Flores",
    programa: "Lic. en Educación."
  }
];
---

<section class="py-10 md:py-14 px-4" aria-labelledby="testimonios-heading">
  <div class="max-w-7xl mx-auto">
    <!-- Encabezado -->
    <div class="text-center mb-8 md:mb-12">
      <h2 id="testimonios-heading" class="text-2xl md:text-4xl font-bold mb-2 text-gray-800">
        Conoce la experiencia en línea de algunos de nuestros alumnos
      </h2>
      <p class="text-base md:text-lg font-semibold text-gray-700">
        Historias reales de personas que transformaron su futuro
      </p>
    </div>

    <!-- Contenedor principal -->
    <div class="flex flex-col lg:flex-row items-center gap-8 lg:gap-12">
      <!-- Imagen - Se mantiene estática -->
      <div class="w-full lg:w-1/2">
        <div class="relative rounded-2xl overflow-hidden shadow-lg">
          <Image 
            src={ResenaImg}
            alt="Estudiante en línea"
            class="w-full h-auto"
            loading="lazy"
          />
        </div>
      </div>

      <!-- Carrusel de testimonios (Custom) -->
      <div class="w-full lg:w-1/2 relative overflow-hidden" id="testimonios-container">
        <div 
          id="testimonios-track" 
          class="flex transition-transform duration-500 ease-out will-change-transform"
          role="region" 
          aria-label="Carrusel de testimonios"
        >
          {testimonios.map((testimonio, index) => (
            <div class="w-full flex-shrink-0 px-1" data-index={index}>
              <div class="bg-azul-une text-white rounded-2xl p-8 md:p-10 shadow-xl relative min-h-[300px] md:min-h-[350px] flex flex-col justify-between h-full">
                <!-- Icono de comillas -->
                <div class="mb-4 opacity-50 w-10">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5.29289 1.29291L6.70711 2.70712L3 6.41423V7.00001H7V14H1V5.5858L5.29289 1.29291Z" fill="#ffffff"></path>
                    <path d="M15 7.00001H11V6.41423L14.7071 2.70712L13.2929 1.29291L9 5.5858V14H15V7.00001Z" fill="#ffffff"></path>
                  </svg>
                </div>
                
                <!-- Texto del testimonio -->
                <div class="">
                  <p class="text-base md:text-lg leading-relaxed mb-6" data-full={testimonio.texto} data-short={testimonio.texto.slice(0, 200)}>
                    {testimonio.texto.slice(0, 200)}&hellip;
                    <button
                      class="ver-mas underline opacity-80 hover:opacity-100 text-sm  ml-1 transition-opacity cursor-pointer"
                      aria-expanded="false"
                    >Ver reseña completa</button>
                  </p>
                </div>
                
                <!-- Autor -->
                <div class="mt-4">
                  <p class="font-bold text-lg md:text-xl">
                    {testimonio.nombre}
                  </p>
                  <p class="text-sm md:text-base opacity-90">
                    {testimonio.programa}
                  </p>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- Pagination Dots -->
        <div class="flex justify-center gap-1 mt-4" id="testimonios-pagination">
          {testimonios.map((_, index) => (
            <button
              class="w-11 h-11 flex items-center justify-center transition-all duration-300 focus:outline-none"
              data-index={index}
              aria-label={`Ir al testimonio ${index + 1}`}
            >
              <div
                class={`h-2.5 rounded-full transition-all duration-300 ${index === 0 ? 'bg-azul-une w-6' : 'bg-gray-300 w-2.5'}`}
              ></div>
            </button>
          ))}
        </div>
      </div>
    </div>

    <!-- CTA Ver todas las reseñas -->
    <div class="flex justify-center mt-8 md:mt-10">
      <a
        href="/acerca/resenas"
        class="inline-flex items-center gap-2 bg-azul-une text-white font-semibold px-7 py-3 rounded-full shadow-md hover:brightness-110 transition-all duration-300 text-base group"
      >
        Ver todas las reseñas
        <svg class="w-4 h-4 translate-x-0 group-hover:translate-x-1 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5l6 6m0 0l-6 6m6-6H4.5" />
        </svg>
      </a>
    </div>
  </div>
</section>

<script>
  class TestimoniosSlider {
    container: HTMLElement | null;
    track: HTMLElement | null;
    slides: NodeListOf<HTMLElement>;
    dots: NodeListOf<HTMLButtonElement>;
    currentIndex: number;
    autoplayInterval: number | null;
    isPaused: boolean;

    constructor() {
      this.container = document.getElementById('testimonios-container');
      this.track = document.getElementById('testimonios-track');
      this.slides = document.querySelectorAll('#testimonios-track > div');
      this.dots = document.querySelectorAll('#testimonios-pagination button');
      this.currentIndex = 0;
      this.autoplayInterval = null;
      this.isPaused = false;

      if (!this.container || !this.track || this.slides.length === 0) return;

      this.init();
    }

    init() {
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goToSlide(index));
      });

      this.container?.addEventListener('mouseenter', () => this.pauseAutoplay());
      this.container?.addEventListener('mouseleave', () => this.resumeAutoplay());

      // Touch events for mobile
      let touchStartX = 0;
      this.container?.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      }, { passive: true });

      this.container?.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) this.nextSlide();
          else this.prevSlide();
        }
      }, { passive: true });

      this.startAutoplay();
    }

    goToSlide(index: number) {
      if (!this.track) return;
      this.currentIndex = index;
      
      // Infinite loop check
      if (this.currentIndex >= this.slides.length) this.currentIndex = 0;
      if (this.currentIndex < 0) this.currentIndex = this.slides.length - 1;

      const offset = this.currentIndex * 100;
      this.track.style.transform = `translateX(-${offset}%)`;

      // Update dots
      this.dots.forEach((dot, i) => {
        const indicator = dot.querySelector('div');
        if (i === this.currentIndex) {
          indicator?.classList.add('bg-azul-une', 'w-6');
          indicator?.classList.remove('bg-gray-300', 'w-2.5');
        } else {
          indicator?.classList.remove('bg-azul-une', 'w-6');
          indicator?.classList.add('bg-gray-300', 'w-2.5');
        }
      });
    }

    nextSlide() {
      this.goToSlide(this.currentIndex + 1);
    }

    prevSlide() {
      this.goToSlide(this.currentIndex - 1);
    }

    startAutoplay() {
      this.stopAutoplay();
      this.autoplayInterval = window.setInterval(() => {
        if (!this.isPaused) this.nextSlide();
      }, 5000);
    }

    stopAutoplay() {
      if (this.autoplayInterval) {
        clearInterval(this.autoplayInterval);
        this.autoplayInterval = null;
      }
    }

    pauseAutoplay() {
      this.isPaused = true;
    }

    resumeAutoplay() {
      this.isPaused = false;
    }
  }

  // "Ver reseña completa" toggle
  let sliderInstance: TestimoniosSlider | null = null;

  function initVerMas() {
    document.querySelectorAll<HTMLButtonElement>('.ver-mas').forEach((btn) => {
      btn.addEventListener('click', () => {
        const p = btn.closest('p');
        if (!p) return;
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          // collapse → reanudar slide
          p.firstChild!.textContent = (p.dataset.short ?? '') + '…';
          btn.textContent = 'Ver reseña completa';
          btn.setAttribute('aria-expanded', 'false');
          sliderInstance?.resumeAutoplay();
        } else {
          // expand → detener slide
          p.firstChild!.textContent = p.dataset.full ?? '';
          btn.textContent = 'Ver menos';
          btn.setAttribute('aria-expanded', 'true');
          sliderInstance?.pauseAutoplay();
        }
      });
    });
  }

  // Initialize on page load and after Astro transitions
  const init = () => { sliderInstance = new TestimoniosSlider(); initVerMas(); };
  document.addEventListener('astro:page-load', init);
  init();
</script>