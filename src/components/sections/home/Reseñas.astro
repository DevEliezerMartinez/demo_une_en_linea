---
import { Image } from 'astro:assets';
import ResenaImg from '@/assets/imagenes/testimonios.webp';

const testimonios = [
  {
    texto: "La experiencia que he tenido ha sido muy accesible, cómoda, y satisfactoria. Ya que se adapta a mis necesidades, y ocupaciones, por lo cual puedo continuar trabajando. Y a la misma vez seguir estudiando. Ya que los horarios son accesibles.",
    nombre: "Pacheco Cuellar Aaron Smirnoff",
    programa: "Lic. Administración"
  },
  {
    texto: "Estudiar en línea me ha permitido balancear mi vida personal y profesional de manera efectiva. La flexibilidad y calidad educativa son excepcionales.",
    nombre: "María González Pérez",
    programa: "Lic. Contaduría"
  },
  {
    texto: "La plataforma es intuitiva y los profesores están siempre disponibles. He logrado desarrollar nuevas habilidades sin sacrificar mi trabajo.",
    nombre: "Carlos Ramírez Torres",
    programa: "Ing. Industrial"
  }
];
---

<section class="py-10 md:py-14 px-4" aria-labelledby="testimonios-heading">
  <div class="max-w-7xl mx-auto">
    <!-- Encabezado -->
    <div class="text-center mb-8 md:mb-12">
      <h2 id="testimonios-heading" class="text-2xl md:text-4xl font-bold mb-2 text-gray-800">
        Conoce la experiencia en línea de algunos de nuestros alumnos
      </h2>
      <p class="text-base md:text-lg font-semibold text-gray-700">
        Historias reales de personas que transformaron su futuro
      </p>
    </div>

    <!-- Contenedor principal -->
    <div class="flex flex-col lg:flex-row items-center gap-8 lg:gap-12">
      <!-- Imagen - Se mantiene estática -->
      <div class="w-full lg:w-1/2">
        <div class="relative rounded-2xl overflow-hidden shadow-lg">
          <Image 
            src={ResenaImg}
            alt="Estudiante en línea"
            class="w-full h-auto"
            loading="lazy"
          />
        </div>
      </div>

      <!-- Carrusel de testimonios (Custom) -->
      <div class="w-full lg:w-1/2 relative overflow-hidden" id="testimonios-container">
        <div 
          id="testimonios-track" 
          class="flex transition-transform duration-500 ease-out will-change-transform"
          role="region" 
          aria-label="Carrusel de testimonios"
        >
          {testimonios.map((testimonio, index) => (
            <div class="w-full flex-shrink-0 px-1" data-index={index}>
              <div class="bg-azul-une text-white rounded-2xl p-8 md:p-10 shadow-xl relative min-h-[300px] md:min-h-[350px] flex flex-col justify-between h-full">
                <!-- Icono de comillas -->
                <div class="mb-4 opacity-50 w-10">
                  <svg aria-hidden="true" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M5.29289 1.29291L6.70711 2.70712L3 6.41423V7.00001H7V14H1V5.5858L5.29289 1.29291Z" fill="#ffffff"></path>
                    <path d="M15 7.00001H11V6.41423L14.7071 2.70712L13.2929 1.29291L9 5.5858V14H15V7.00001Z" fill="#ffffff"></path>
                  </svg>
                </div>
                
                <!-- Texto del testimonio -->
                <div class="grow">
                  <p class="text-base md:text-lg leading-relaxed mb-6">
                    {testimonio.texto}
                  </p>
                </div>
                
                <!-- Autor -->
                <div class="mt-4">
                  <p class="font-bold text-lg md:text-xl">
                    {testimonio.nombre}
                  </p>
                  <p class="text-sm md:text-base opacity-90">
                    {testimonio.programa}
                  </p>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- Pagination Dots -->
        <div class="flex justify-center gap-2 mt-6" id="testimonios-pagination">
          {testimonios.map((_, index) => (
            <button
              class={`w-3 h-3 rounded-full transition-all duration-300 ${index === 0 ? 'bg-azul-une w-6' : 'bg-gray-300'}`}
              data-index={index}
              aria-label={`Ir al testimonio ${index + 1}`}
            ></button>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  class TestimoniosSlider {
    container: HTMLElement | null;
    track: HTMLElement | null;
    slides: NodeListOf<HTMLElement>;
    dots: NodeListOf<HTMLButtonElement>;
    currentIndex: number;
    autoplayInterval: number | null;
    isPaused: boolean;

    constructor() {
      this.container = document.getElementById('testimonios-container');
      this.track = document.getElementById('testimonios-track');
      this.slides = document.querySelectorAll('#testimonios-track > div');
      this.dots = document.querySelectorAll('#testimonios-pagination button');
      this.currentIndex = 0;
      this.autoplayInterval = null;
      this.isPaused = false;

      if (!this.container || !this.track || this.slides.length === 0) return;

      this.init();
    }

    init() {
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', () => this.goToSlide(index));
      });

      this.container?.addEventListener('mouseenter', () => this.pauseAutoplay());
      this.container?.addEventListener('mouseleave', () => this.resumeAutoplay());

      // Touch events for mobile
      let touchStartX = 0;
      this.container?.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
      }, { passive: true });

      this.container?.addEventListener('touchend', (e) => {
        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          if (diff > 0) this.nextSlide();
          else this.prevSlide();
        }
      }, { passive: true });

      this.startAutoplay();
    }

    goToSlide(index: number) {
      if (!this.track) return;
      this.currentIndex = index;
      
      // Infinite loop check
      if (this.currentIndex >= this.slides.length) this.currentIndex = 0;
      if (this.currentIndex < 0) this.currentIndex = this.slides.length - 1;

      const offset = this.currentIndex * 100;
      this.track.style.transform = `translateX(-${offset}%)`;

      // Update dots
      this.dots.forEach((dot, i) => {
        if (i === this.currentIndex) {
          dot.classList.add('bg-azul-une', 'w-6');
          dot.classList.remove('bg-gray-300');
        } else {
          dot.classList.remove('bg-azul-une', 'w-6');
          dot.classList.add('bg-gray-300');
        }
      });
    }

    nextSlide() {
      this.goToSlide(this.currentIndex + 1);
    }

    prevSlide() {
      this.goToSlide(this.currentIndex - 1);
    }

    startAutoplay() {
      this.stopAutoplay();
      this.autoplayInterval = window.setInterval(() => {
        if (!this.isPaused) this.nextSlide();
      }, 5000);
    }

    stopAutoplay() {
      if (this.autoplayInterval) {
        clearInterval(this.autoplayInterval);
        this.autoplayInterval = null;
      }
    }

    pauseAutoplay() {
      this.isPaused = true;
    }

    resumeAutoplay() {
      this.isPaused = false;
    }
  }

  // Initialize on page load and after Astro transitions
  const init = () => new TestimoniosSlider();
  document.addEventListener('astro:page-load', init);
  init();
</script>